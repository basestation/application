"use strict";angular.module("basestationApp",["firebase","angular-md5","ui.router"]).config(["$stateProvider","$urlRouterProvider",function(a,b){a.state("home",{url:"/",templateUrl:"home/home.html",resolve:{requireNoAuth:["$state","Auth",function(a,b){return b.$requireAuth().then(function(b){a.go("dashboard")},function(a){})}]}}).state("login",{url:"/login",controller:"AuthCtrl as authCtrl",templateUrl:"auth/login.html",resolve:{requireNoAuth:["$state","Auth",function(a,b){return b.$requireAuth().then(function(b){a.go("home")},function(a){})}]}}).state("register",{url:"/register",controller:"AuthCtrl as authCtrl",templateUrl:"auth/register.html",resolve:{requireNoAuth:["$state","Auth",function(a,b){return b.$requireAuth().then(function(b){a.go("home")},function(a){})}]}}).state("dashboard",{url:"/dashboard",controller:"DashboardCtrl as dashboardCtrl",templateUrl:"dashboard/index.html",resolve:{auth:["$state","Users","Auth",function(a,b,c){return c.$requireAuth()["catch"](function(){a.go("home")})}],dashboard:["Users","Auth",function(a,b){return b.$requireAuth().then(function(b){return a.getProfile(b.uid).$loaded()})}]}}).state("about",{url:"/about",templateUrl:"about/index.html"}).state("profile",{url:"/profile",controller:"ProfileCtrl as profileCtrl",templateUrl:"users/profile.html",resolve:{auth:["$state","Users","Auth",function(a,b,c){return c.$requireAuth()["catch"](function(){a.go("home")})}],profile:["Users","Auth",function(a,b){return b.$requireAuth().then(function(b){return a.getProfile(b.uid).$loaded()})}]}}).state("environments",{url:"/environments",controller:"EnvironmentsCtrl as environmentsCtrl",templateUrl:"environments/index.html",resolve:{environments:["Environments",function(a){return a.$loaded()}],auth:["$state","Users","Auth",function(a,b,c){return c.$requireAuth()["catch"](function(){a.go("home")})}]}}).state("environments.create",{url:"/create",templateUrl:"environments/create.html",controller:"EnvironmentsCtrl as environmentsCtrl"}).state("channels",{url:"/channels",controller:"ChannelsCtrl as channelsCtrl",templateUrl:"channels/index.html",resolve:{channels:["Channels",function(a){return a.$loaded()}],profile:["$state","Auth","Users",function(a,b,c){return b.$requireAuth().then(function(b){return c.getProfile(b.uid).$loaded().then(function(b){return b.displayName?b:void a.go("profile")})},function(b){a.go("home")})}]}}).state("channels.create",{url:"/create",templateUrl:"channels/create.html",controller:"ChannelsCtrl as channelsCtrl"}).state("channels.messages",{url:"/{channelId}/messages",templateUrl:"channels/messages.html",controller:"MessagesCtrl as messagesCtrl",resolve:{messages:["$stateParams","Messages",function(a,b){return b.forChannel(a.channelId).$loaded()}],channelName:["$stateParams","channels",function(a,b){return"#"+b.$getRecord(a.channelId).name}]}}).state("channels.direct",{url:"/{uid}/messages/direct",templateUrl:"channels/messages.html",controller:"MessagesCtrl as messagesCtrl",resolve:{messages:["$stateParams","Messages","profile",function(a,b,c){return b.forUsers(a.uid,c.$id).$loaded()}],channelName:["$stateParams","Users",function(a,b){return b.all.$loaded().then(function(){return"@"+b.getDisplayName(a.uid)})}]}}),b.otherwise("/")}]).constant("FirebaseUrl","https://basestation.firebaseio.com/"),angular.module("basestationApp").factory("Auth",["$firebaseAuth","FirebaseUrl",function(a,b){var c=new Firebase(b),d=a(c);return d}]),angular.module("basestationApp").controller("AuthCtrl",["Auth","$state",function(a,b){var c=this;c.user={email:"",password:""},c.login=function(){a.$authWithPassword(c.user).then(function(a){b.go("home")},function(a){c.error=a})},c.register=function(){a.$createUser(c.user).then(function(a){c.login()},function(a){c.error=a})}}]),angular.module("basestationApp").factory("Users",["$firebaseArray","$firebaseObject","FirebaseUrl",function(a,b,c){var d=new Firebase(c+"users"),e=new Firebase(c+".info/connected"),f=a(d),g={getProfile:function(a){return b(d.child(a))},getDisplayName:function(a){return f.$getRecord(a).displayName},getGravatar:function(a){return"//www.gravatar.com/avatar/"+f.$getRecord(a).emailHash},setOnline:function(c){var f=b(e),g=a(d.child(c+"/online"));f.$watch(function(){f.$value===!0&&g.$add(!0).then(function(a){a.onDisconnect().remove()})})},all:f};return g}]),angular.module("basestationApp").controller("ProfileCtrl",["$state","Auth","md5","auth","profile",function(a,b,c,d,e){var f=this;f.profile=e,f.updateProfile=function(){f.profile.emailHash=c.createHash(d.password.email),f.profile.$save().then(function(){a.go("channels")})},f.logout=function(){f.profile.online=null,f.profile.$save().then(function(){b.$unauth(),a.go("home")})}}]),angular.module("basestationApp").controller("DashboardCtrl",["$state","md5","auth",function(a,b,c){}]),angular.module("basestationApp").factory("Channels",["$firebaseArray","FirebaseUrl",function(a,b){var c=new Firebase(b+"channels"),d=a(c);return d}]),angular.module("basestationApp").controller("ChannelsCtrl",["$state","Auth","Users","profile","channels",function(a,b,c,d,e){var f=this;f.profile=d,f.channels=e,f.getDisplayName=c.getDisplayName,f.getGravatar=c.getGravatar,f.users=c.all,c.setOnline(d.$id),f.logout=function(){f.profile.online=null,f.profile.$save().then(function(){b.$unauth(),a.go("home")})},f.newChannel={name:""},f.createChannel=function(){f.channels.$add(f.newChannel).then(function(b){a.go("channels.messages",{channelId:b.key()})})}}]),angular.module("basestationApp").factory("Messages",["$firebaseArray","FirebaseUrl",function(a,b){var c=new Firebase(b+"channelMessages"),d=new Firebase(b+"userMessages");return{forChannel:function(b){return a(c.child(b))},forUsers:function(b,c){var e=c>b?b+"/"+c:c+"/"+b;return a(d.child(e))}}}]),angular.module("basestationApp").controller("MessagesCtrl",["profile","channelName","messages",function(a,b,c){var d=this;d.messages=c,d.channelName=b,d.message="",d.sendMessage=function(){d.message.length>0&&d.messages.$add({uid:a.$id,body:d.message,timestamp:Firebase.ServerValue.TIMESTAMP}).then(function(){d.message=""})}}]),angular.module("basestationApp").factory("Environments",["$firebaseArray","FirebaseUrl",function(a,b){var c=new Firebase(b+"environments"),d=a(c);return d}]),angular.module("basestationApp").controller("EnvironmentsCtrl",["$state","Auth","environments",function(a,b,c){var d=this;d.environments=c,d.newEnvironment={name:"",description:""},d.createEnvironment=function(){d.environments.$add(d.newEnvironment).then(function(b){a.go("environments.create",{environmentId:b.key()})})}}]);